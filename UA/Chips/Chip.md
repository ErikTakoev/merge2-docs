# Chip (Базовий Чіп)

[← На Головну](../Main.md)

Базовий клас `Chip` є візуальним представленням та компонентом взаємодії для об'єктів на ігровому полі. Він відповідає за відображення стану, ефектів та обробку Unity подій (Input).

Сама логіка злиття (Merge) та переміщення винесена у відповідні логічні класи.

## Архітектура та Відповідальність

### 1. `Chip.cs` (Базовий Клас)
Клас `Chip` є візуальним представленням та базовим компонентом.
- **Властивості (Data)**: Зберігає посилання на `ChipData`.
  - **Type**: Ідентифікатор типу фішки (string).
  - **MergeData**: Конфігурація злиття. Тепер підтримує список можливих партнерів та ймовірнісні результати.
  - **Size**: Розмір фішки в клітинках (Vector2Int).
  - **CellPosition**: Поточна позиція фішки на сітці поля (Vector2Int).
- **Ефекти**: Керує візуальними ефектами, детальніше див. [Visual Effects](../Visuals/Effects.md):
  - `MergeAvailableEffect`: Підсвітка при можливості злиття ([ChipMergeAvailableEffect](../Visuals/Effects.md#2-merge-available-доступність-злиття)).
  - `CellHighlightEffect`: Підсвітка клітинки під фішкою ([CellHighlightEffect](../Visuals/Effects.md#1-cell-highlight-підсвітка-клітин)).
- **Анімація**: Має посилання на `Animator` для відтворення станів (наприклад, `Merge`).

### 2. `MergeableChipLogic.cs` (Логіка Злиття)
Вся логіка об'єднання фішок реалізована в цьому класі.
- **Перевірка (`CanInteract`)**:
  - Використовує `MergeData` ініціюючої фішки (source), щоб перевірити, чи є цільова фішка (target) у списку допустимих партнерів для злиття.
  - Перевіряє наявність та активність `MergeData`.
- **Виконання (`ExecuteInteraction`)**:
  - Визначає результат злиття через `GetNextChip`, враховуючи налаштовані ваги (Weighted Random), якщо для даної пари партнерів передбачено кілька варіантів результату.
  - Обробляє ситуації, коли нова фішка більша за попередні (зсув сусідніх фішок через `IChipMovingLogic`).
  - Знищує обидві вихідні фішки.
  - Створює нову фішку через `ChipFactory`.
  - Запускає анімацію злиття.

### 3. `DraggableChipLogic.cs` (Input)
Обробляє Input гравця (Drag-and-Drop). Використовує `MergeableChipLogic` для перевірки дій гравця.

## Правила Злиття (ChipMergeData)

`ChipMergeData` — це об'єкт налаштувань, який визначає, з ким і як може зливатися чіп. Він підтримує складні сценарії, включаючи злиття різних типів чіпів та випадкові результати.

### Структура Даних

1. **`MergeData`**: Визначає правила для конкретної пари фішок. Містить посилання на `MergeableChipData` (партнер) та список можливих результатів.
2. **`MergeNextChipData`**: Описує конкретний результат злиття (`NextChipData`) та його **Weight** (вагу/ймовірність).

### Розрахунок Результату

При злитті система використовує алгоритм **Weighted Random**:
- Збираються всі можливі результати для даного партнера.
- На основі їхніх ваг обирається один фінальний чіп.
- Якщо варіант лише один з вагою 100, він обирається гарантовано.

### Автоматизація в Редакторі

Для зручності, `ChipCreatorWindow` автоматично ініціалізує базове правило при ввімкненні Merge: створюється запис про злиття чіпа з самим собою, де результатом є він же.

## Процес Злиття (Flow)

1. **Input**: Гравець перетягує фішку (`DraggableChipLogic`).
2. **Move**: При переміщенні над іншою фішкою викликається `CanInteract` з `MergeableChipLogic`.
3. **Feedback**: Якщо `CanInteract` = true (партнер є в списку `MergeData`), на нижній фішці активується ефект (`Chip.MergeAvailableEffect`).
4. **Drop**: При відпусканні фішки викликається `ExecuteInteraction`.
5. **Result**: Система обирає результат через Weighted Random, знищує старі фішки та створює нову через `ChipFactory`.
