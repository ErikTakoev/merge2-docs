# ChipGenerator (Генератор)

[← На Головну](../Main.md)

`ChipGenerator` — це спеціалізований компонент, який створює (спавнить) нові фішки на ігровому полі. Він працює як автомат станів (State Machine), що перемикається між заряджанням та готовністю до генерації.

## Архітектура та Відповідальність

### 1. `ChipGenerator.cs` (Основний Компонент)
Клас `ChipGenerator` керує життєвим циклом генератора, об'єднуючи логіку оновлення та події.
- **Вхідні дані (Input)**:
  - **Manual**: Обробляє `OnTap` (клік гравця).
  - **Auto**: Підписується на `field.OnChangeField`, щоб автоматично спавнити при появі вільного місця.
- **Update Loop**: У методі `Update` керує таймером перезарядки.
- **Залежності**:
  - `IFreeCellFinder`: Логіка пошуку найближчої вільної клітинки.
  - `ChipFactory`: Фабрика для створення нових об'єктів.

### 2. `ChipGeneratorData.cs` (Налаштування)
Дані містять налаштування та алгоритми вибору.
- **Властивості**:
  - `SpawnParameters`: Ваги ймовірностей для різних типів фішок.
  - `ChargeCount/ChargingTime`: Параметри балансу.
  - `TotalRecharges`: Ліміт життя генератора.
- **Логіка (`GenerateChipData`)**: Метод, що виконує зважений випадковий вибір (`Weighted Random`) для визначення наступної фішки.

### 3. `ChipGeneratorRuntimeData.cs` (Стан)
Окремий клас для зберігання динамічного стану.
- **Поля**:
  - `IsCharged`: Чи готовий до спавну.
  - `RechargesLeft`: Скільки циклів залишилось.
  - `IsWaitingForSpace`: Стан очікування (для Auto режиму).

## Процес (Flow)

### Генерація
1. **Trigger**: Подія `OnTap` або `Update` (якщо Auto).
2. **Check**: Перевірка наявності заряду (`IsCharged`) та вільного місця (`IFreeCellFinder`).
3. **Select**: Виклик `generatorData.GenerateChipData()` для вибору типу фішки.
4. **Spawn**: `ChipFactory.CreateChip` у знайденій клітинці.
5. **Consume**: Зменшення `ChargeCount`. Якщо 0 — перехід до перезарядки (`Start Recharging`) або знищення, якщо ліміт вичерпано.

### Перезарядка (Recharge)
1. **Update**: У кожному кадрі збільшується `ChargingTimeLeft`.
2. **Visuals**: Викликається подія `OnCharging` -> `ChipGeneratorEffect` оновлює маску прогресу.
3. **Complete**: Коли час вичерпано, відновлюються заряди, відтворюється анімація `Recharge`.

## Ефекти та Візуалізація
- **[ChipGeneratorEffect](../Visuals/Effects.md#3-chip-generator-прогрес-генератора)**: Відображає прогрес перезарядки (через `maskRectTransform`).
- **Animator**: Використовує тригери `Generate` (при спавні) та `Recharge` (при завершенні зарядки).
