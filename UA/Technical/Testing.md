# Тестування (Testing)

[← На Головну](../README.md)


Проект використовує комбінацію Integration та Unit тестів для забезпечення стабільності.

## Інтеграційні Тести
Розташовані в `Modules/Merge2/Tests/Scripts/Integration/`. Перевіряють роботу системи в зборі на реальному полі (або його емуляції).

### ChipBaseTests
Тести базової функціональності створення, переміщення та злиття чіпів.

#### CreateChip_SpawnChips
- **Мета**: Перевіряє коректність спавну чіпів різних розмірів через `ChipFactory` та `IFreeCellFinder`.
- **Сценарій**: Заповнює поле чіпами різних розмірів від центру, використовуючи `FindNearestFreeCell` для пошуку вільних клітинок. Перевіряє цілісність посилань між чіпами та клітинками після спавну.

#### CreateChip_DraggingChip
- **Мета**: Перевіряє коректність переміщення чіпів через drag-and-drop.
- **Сценарій**: Створює кілька чіпів на полі та симулює перетягування одного з них на іншу позицію. Перевіряє цілісність поля після переміщення.

#### DraggingChip_RandomMoves
- **Мета**: Перевіряє стабільність системи при великій кількості випадкових переміщень.
- **Сценарій**: Заповнює поле чіпами, потім виконує 2000 випадкових drag операцій між випадковими клітинками. Перевіряє цілісність поля після всіх операцій.

#### MergeableChip_NextChipIsBiggerThanParent
- **Мета**: Перевіряє коректність злиття чіпів, коли результуючий чіп більший за вихідні.
- **Сценарій**: Створює чіпи різних розмірів та симулює злиття меншого чіпа з більшим, що призводить до створення ще більшого чіпа. Перевіряє кількість чіпів та цілісність поля після злиття.

### ChipGeneratorTests
Тести функціональності ручного генератора чіпів (`IsAutoGeneration = false`).

#### ManualGenerator_SpawnsChipOnTap
- **Мета**: Перевіряє, що генератор створює чіп при тапі та зменшує кількість зарядів.
- **Сценарій**: Створює заряджений генератор, симулює тап на нього. Перевіряє, що чіп був створений та кількість зарядів зменшилась.

#### ManualGenerator_EntersRechargingState
- **Мета**: Перевіряє, що генератор переходить у стан перезарядки після використання всіх зарядів.
- **Сценарій**: Створює генератор з двома зарядами, використовує обидва. Перевіряє, що генератор не заряджений та кількість зарядів дорівнює 0.

#### ManualGenerator_RechargesCorrectly
- **Мета**: Перевіряє коректність перезарядки генератора після використання всіх зарядів.
- **Сценарій**: Створює генератор з трьома зарядами, використовує всі, чекає час перезарядки. Перевіряє, що генератор знову заряджений та кількість зарядів відновилась.

#### ManualGenerator_Evolution
- **Мета**: Перевіряє, що генератор еволюціонує в `NextChipData` після використання всіх перезарядок.
- **Сценарій**: Створює генератор з `TotalRecharges = 1` та `NextChipData`, використовує всі перезарядки. Перевіряє, що генератор замінився на `NextChipData`.

#### ManualGenerator_NoSpace
- **Мета**: Перевіряє поведінку генератора при спробі створити чіп, коли на полі немає вільного місця.
- **Сценарій**: Заповнює поле повністю, залишаючи тільки клітинку з генератором. Симулює тап на генератор. Перевіряє, що новий чіп не був створений.

#### ManualGenerator_StartsUncharged_Recharges
- **Мета**: Перевіряє поведінку генератора, який починає без заряду (`IsStartCharged = false`).
- **Сценарій**: Створює незаряджений генератор, чекає час перезарядки, симулює тап. Перевіряє, що генератор заряджається та створює чіп після тапу.

#### ManualGenerator_InfiniteRecharges
- **Мета**: Перевіряє, що генератор з `TotalRecharges = 0` може перезаряджатися нескінченно.
- **Сценарій**: Створює генератор з нескінченними перезарядками, виконує кілька циклів використання-перезарядки. Перевіряє, що генератор залишається на полі та продовжує працювати.

#### ManualGenerator_FiniteRecharges_Evolution
- **Мета**: Перевіряє еволюцію генератора після скінченної кількості перезарядок.
- **Сценарій**: Створює генератор з `TotalRecharges = 2` та `NextChipData`, використовує всі перезарядки. Перевіряє, що генератор еволюціонував у `NextChipData`.

#### ManualGenerator_FiniteRecharges_Destruction
- **Мета**: Перевіряє знищення генератора після скінченної кількості перезарядок, коли `NextChipData = null`.
- **Сценарій**: Створює генератор з `TotalRecharges = 2` та `NextChipData = null`, використовує всі перезарядки. Перевіряє, що генератор був знищений.

### AutoChipGeneratorTests
Тести функціональності автоматичного генератора чіпів (`IsAutoGeneration = true`).

#### AutoGenerator_SpawnsChipAutomaticallyWhenCharged
- **Мета**: Перевіряє, що автоматичний генератор створює чіп автоматично при зарядці без втручання користувача.
- **Сценарій**: Створює заряджений автоматичний генератор, чекає один кадр. Перевіряє, що чіп був створений автоматично.

#### AutoGenerator_EntersWaitingStateWhenNoSpace
- **Мета**: Перевіряє, що генератор переходить у стан очікування (`IsWaitingForSpace`), коли на полі немає вільного місця.
- **Сценарій**: Заповнює поле повністю, залишаючи тільки клітинку з генератором. Чекає спробу автоматичної генерації. Перевіряє, що генератор у стані очікування та новий чіп не був створений.

#### AutoGenerator_GeneratesWhenSpaceBecomesAvailable
- **Мета**: Перевіряє, що генератор автоматично створює чіп, коли з'являється вільне місце після зміни поля.
- **Сценарій**: Заповнює поле, генератор переходить у стан очікування. Видаляє чіп з поля та викликає `NotifyFieldChanged()`. Перевіряє, що генератор створив чіп після звільнення місця.

#### AutoGenerator_EntersWaitingStateDuringDrag
- **Мета**: Перевіряє, що генератор переходить у стан очікування під час перетягування.
- **Сценарій**: Створює заряджений генератор, починає перетягування генератора. Перевіряє поведінку генератора під час та після перетягування.

#### AutoGenerator_StartsUncharged_RechargesAndGenerates
- **Мета**: Перевіряє поведінку автоматичного генератора, який починає без заряду.
- **Сценарій**: Створює незаряджений автоматичний генератор, чекає час перезарядки. Перевіряє, що генератор автоматично створив чіп після перезарядки.

#### AutoGenerator_Evolution
- **Мета**: Перевіряє еволюцію автоматичного генератора після використання всіх перезарядок.
- **Сценарій**: Створює автоматичний генератор з `TotalRecharges = 1` та `NextChipData`, чекає завершення всіх циклів генерації. Перевіряє, що генератор еволюціонував у `NextChipData`.

#### AutoGenerator_InfiniteRecharges
- **Мета**: Перевіряє, що автоматичний генератор з `TotalRecharges = 0` може перезаряджатися нескінченно.
- **Сценарій**: Створює автоматичний генератор з нескінченними перезарядками, чекає кілька циклів генерації-перезарядки. Перевіряє, що генератор залишається на полі та продовжує автоматично створювати чіпи.

#### AutoGenerator_FiniteRecharges_Evolution
- **Мета**: Перевіряє еволюцію автоматичного генератора після скінченної кількості перезарядок.
- **Сценарій**: Створює автоматичний генератор з `TotalRecharges = 2` та `NextChipData`, чекає завершення всіх циклів. Перевіряє, що генератор еволюціонував у `NextChipData`.

#### AutoGenerator_FiniteRecharges_Destruction
- **Мета**: Перевіряє знищення автоматичного генератора після скінченної кількості перезарядок, коли `NextChipData = null`.
- **Сценарій**: Створює автоматичний генератор з `TotalRecharges = 2` та `NextChipData = null`, чекає завершення всіх циклів. Перевіряє, що генератор був знищений.

### ChipContainerTests
Тести функціональності контейнера для чіпів (`ChipContainer`).

#### SpawnChipContainer_And_GoldGenerator
- **Мета**: Перевіряє взаємодію контейнера з генератором золота, включаючи споживання чіпів та автоматичне спавнення.
- **Сценарій**: Створює контейнер та генератор золота. Симулює перетягування золотого чіпа в контейнер. Перевіряє, що генератор продовжує спавнити нові чіпи, а контейнер успішно приймає їх. Валідує цілісність поля після всіх маніпуляцій.

## Інструментарій (Helpers)

### TestFieldBuilder
Клас-помічник для створення тестового оточення.
- **Використання**: Завантажує префаб `Merge2_Field`, налаштовує DI Container, ініціалізує поле.
- **Ізоляція**: Метод `ClearField()` дозволяє очистити поле між тестами без перезавантаження сцени.

### FieldAssertions
Набір методів для валідації стану поля.
- `AssertFieldConsistency(field)`: Перевіряє цілісність посилань:
  - Чи кожна фішка в `MainCell` коректно посилається на свої `SecondaryCells`.
  - Чи всі клітинки під фішкою мають правильні посилання на цю фішку.
  - Чи немає "фантомних" блокувань.

### TestHelper
Статичний клас з допоміжними методами для тестів.
- `FindChipByChipId(field, chipId, exclude)`: Знаходить на полі вказаний чіп за його назвою (ID), дозволяючи виключити вже знайдені чіпи.
- `WaitForSingleRun()`: Пауза для візуального контролю при запуску одного тесту вручну.

## Принципи Написання Тестів
1. **Clean Slate**: Кожен тест має починатися з чистого поля.
2. **Real Input Simulation**: Використовуйте `InputHelper` для емуляції кліків/drag, замість прямого виклику методів логіки (де це можливо), щоб тестувати повний пайплайн.
3. **Assert Consistency**: Після кожної складної маніпуляції (Merge, Move) викликайте `AssertFieldConsistency`.
